from __future__ import annotations

from langchain_core.messages import AIMessage

from state import AgentState
from tools.security_tools import run_exploit_script

# ツールリスト
EXPLOIT_TOOLS = [run_exploit_script]


def exploit_node(state: AgentState) -> AgentState:
    """
    Exploit エージェント
    PoCを1つ試行し、結果を Operator に報告する。
    Operatorが成功/失敗に基づいて次のアクションを決定。
    """
    dry_run = bool(state.get("dry_run", False))
    poc_info = list(state.get("poc_info", []))
    current_attempt = state.get("exploit_attempts", 0)
    previous_results = state.get("exploit_results", "")
    messages = list(state.get("messages", []))
    
    # 既に成功している場合はスキップ
    if state.get("exploit_success", False):
        messages.append(AIMessage(content="Exploit: 既に成功済み → Operator へ"))
        return state
    
    # 試行するPoCがない場合
    if not poc_info:
        messages.append(AIMessage(content="Exploit: 試行する PoC がありません → Operator へ"))
        return {
            **state,
            "exploit_success": False,
            "messages": messages,
        }
    
    # 現在の試行回数に対応する PoC を取得
    poc_index = current_attempt % len(poc_info)
    current_poc = poc_info[poc_index]
    
    messages.append(AIMessage(content=f"Exploit: 試行中 - {current_poc}"))
    
    # エクスプロイト実行（ツール使用）
    try:
        result = run_exploit_script.invoke({"poc_ref": current_poc, "dry_run": dry_run})
        messages.append(AIMessage(content=f"  [Tool:Exploit] {result}"))
    except Exception as e:
        result = f"エラー: {e}"
        messages.append(AIMessage(content=f"  [Tool:Exploit] {result}"))
    
    # 結果を蓄積
    results_list = previous_results.split("\n") if previous_results else []
    results_list.append(result)
    combined_results = "\n".join([r for r in results_list if r])
    
    # 成功判定
    is_success = "success" in result.lower()
    
    status = "成功" if is_success else "失敗"
    messages.append(AIMessage(content=f"Exploit: {status} → Operator へ報告"))
    
    return {
        **state,
        "exploit_results": combined_results,
        "exploit_success": is_success,
        "exploit_attempts": current_attempt + 1,
        "messages": messages,
    }
