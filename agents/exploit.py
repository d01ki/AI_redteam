"""
Exploit エージェント
エクスプロイトの実行を担当
"""
from __future__ import annotations

from langchain_anthropic import ChatAnthropic
from langchain.agents import create_react_agent
from langchain_core.prompts import ChatPromptTemplate
from tools.security_tools import simulate_exploit_execution
import config


def create_exploit_agent():
    """
Exploit エージェントを生成。
エクスプロイトの実行（またはシミュレーション）。
    """
    llm = ChatAnthropic(
        model=config.MODEL_NAME,
        api_key=config.ANTHROPIC_API_KEY,
        temperature=0,
    )
    
    tools = [simulate_exploit_execution]
    
    system_prompt = """You are an Exploit Execution Specialist.
    
Your responsibilities:
1. Execute (or simulate) exploit code against the target
2. Monitor and report on exploit execution results
3. Analyze failure reasons when exploits don't succeed
4. Recommend adjustments or alternative approaches
5. Ensure all testing is done safely and ethically

IMPORTANT SAFETY NOTES:
- Only execute exploits in authorized, controlled environments
- Use dry_run mode for simulation when actual execution is not safe
- Always document what was tested and the results
- Never cause actual harm to production systems

When you finish execution, provide:
- Clear success/failure status
- Details of what was executed
- Any errors or issues encountered
- Recommendations for next steps
"""
    
    prompt = ChatPromptTemplate.from_messages([
        ("system", system_prompt),
        ("human", "{input}"),
        ("placeholder", "{agent_scratchpad}"),
    ])
    
    agent = create_react_agent(llm, tools, prompt)
    return agent